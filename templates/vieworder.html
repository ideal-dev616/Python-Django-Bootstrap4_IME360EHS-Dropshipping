{% extends 'layout/app.html' %} {% load static %}
{% block stylesheet %}
    <link href="{% static 'assets/node_modules/datatables.net-bs4/css/dataTables.bootstrap4.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'assets/node_modules/datatables.net-bs4/css/responsive.dataTables.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'assets/node_modules/dropify/dist/css/dropify.min.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/node_modules/bootstrap-switch/bootstrap-switch.min.css' %}" rel="stylesheet" />
    <link href="{% static 'dist/css/pages/bootstrap-switch.css' %}" rel="stylesheet" />
    <link href="{% static 'dist/css/pages/ribbon-page.css' %}" rel="stylesheet" />
{% endblock %}

{% block styleblock %}
    <style>
        .order-detail-header{
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            margin-right: -10px;
        }

        .remove-left-padding{
            padding: 0;
        }
    </style>
{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="container-fluid" style="padding: 0 70px;">
        <div class="row page-titles">
            <div class="col-md-5 align-self-center">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                    <li class="breadcrumb-item active">View Orders</li>
                </ol>
            </div>
            <div class="col-md-7 align-self-center">
                <div class="d-flex justify-content-end align-items-center">
                    <div id="modal_newshipment" class="modal bs-example-modal-lg" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="myLargeModalLabel">Specify Items and Quantities for Invoice</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                </div>
                                <div class="modal-body">
                                    <div class="row m-t-20" style="margin: 10px 20px 0px 20px; border-bottom: 1px solid #e9ecef;">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="control-label">Shipping Date</label>
                                                <input type="date" id="date_newInvoice" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-5"></div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="control-label">Order Number</label>
                                                <input type="text" id="tf_createshipid" class="form-control form-control-danger">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive m-t-20">
                                        <table id="tbl_CreateInvoice" class="table table-bordered table-striped myTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Product Description</th>
                                                    <th>Cost ($)</th>
                                                    <th>Ordered</th>
                                                    <th>Pre Invoiced</th>
                                                    <th width="100">To Invoice</th>
                                                </tr>
                                            </thead>
                                            <tfoot>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Product Description</th>
                                                    <th>Cost ($)</th>
                                                    <th>Ordered</th>
                                                    <th>Pre Invoiced</th>
                                                    <th width="100">To Invoice</th>
                                                </tr>
                                            </tfoot>
                                            <tbody>
                                                
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer" style="margin:10px;">
                                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                                        <button type="button" id="btn_createinvoice" class="btn btn-primary waves-effect waves-light">Send Shipment</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if request.session.userrole == "Supplier" or request.session.userrole == "System Admin" %}
                    <button type="button" data-toggle="modal" data-target="#modal_newshipment" class="btn btn-primary d-none d-lg-block m-l-15" id="btn_newship"><i
                            class="fa fa-plus-circle"></i> Create New Shipment</button>
                    {% elif request.session.userrole == "Clinic User" or request.session.userrole == "Clinic Manager" %}
                    <button type="button" class="btn btn-primary d-none d-lg-block m-l-15" id="btn_repeatLastOrder"><i
                        class="fa fa-plus-circle"></i> Repeat & Create new Order</button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-9">
                <div class="card">
                    <div class="card-body" style="padding: 1.25rem 0;">
                        <div class="table-responsive">
                            <table id="tbl_orderedproducts" class="table table-bordered table-striped myTable">
                                <thead>
                                    <tr>
                                        <th width="80">No</th>
                                        <th>Product Description</th>
                                        <th>Unit</th>
                                        <th>Cost ($)</th>
                                        <th>Retail ($)</th>
                                        <th>Ordered</th>
                                        <th>BOrdered</th>
                                        <th>Invoiced</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                        <th>No</th>
                                        <th>Product Description</th>
                                        <th>Unit</th>
                                        <th>Cost ($)</th>
                                        <th>Retail ($)</th>
                                        <th>Ordered</th>
                                        <th>BOrdered</th>
                                        <th>Invoiced</th>
                                    </tr>
                                </tfoot>
                                <tbody>
                                    {% for product in orderedproducts %}
                                    <tr id="{{product.0}}">
                                        <td>{{product.1}}</td>
                                        <td>{{product.2}}</td>
                                        <td>{{product.3}}</td>
                                        <td>{{product.4}}</td>
                                        <td>{{product.5}}</td>
                                        <td class="qty_ordered">{{product.6}}</td>
                                        <td>{{product.7}}</td>
                                        <td>{{product.8}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="row m-t-20 m-l-15 m-r-15">
                            <div class="col-12">
                                <div class="ribbon-wrapper card bg-light">
                                    <div class="ribbon ribbon-bookmark ribbon-success">Order Notes</div>
                                    <textarea class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row m-l-15 m-r-15">
                            <div class="col-4">
                                <!-- <button type="button" class="btn btn-success d-none d-lg-block" style="width:100%;" id="btn_updateorder">Update Order</button> -->
                            </div>
                            <div class="col-4">
                                <!-- <button type="button" class="btn btn-success d-none d-lg-block" style="width:100%;" id="btn_resend_order_emails">Resend Order Emails</button> -->
                            </div>
                            <div class="col-4">
                                {% if request.session.userrole == "System Admin" %}
                                <button type="button" class="btn btn-primary d-none d-lg-block" style="width:100%;" id="btn_addclinic">Sync with QBO</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="ribbon-wrapper card bg-light">
                    <div class="ribbon ribbon-bookmark ribbon-success">Order Details</div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Order ID:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.0}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Date:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.1}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">User:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.7}}&nbsp;{{orderdetail.8}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Phone:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.10}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Email:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted" id="byemail">{{orderdetail.9}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Clinic:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.2}}</p>
                        </div>
                    </div>
                    <div class="row" style="padding: 0 10px 10px 10px;">
                        <div class="col-4 order-detail-header">Address:</div>
                        <div class="col-8 remove-left-padding">
                            <p class="text-muted">{{orderdetail.3}}<br>{{orderdetail.4}}<br>{{orderdetail.5}}, {{orderdetail.6}}</p>
                        </div>
                    </div>
                </div>
                <div class="ribbon-wrapper card bg-light">
                    <div class="ribbon ribbon-bookmark ribbon-success">Invoice History</div>
                    <table id="tbl_invoiceList" class="table table-hover no-wrap">
                        <thead>
                            <tr class="unread">
                                <td class="hidden-xs-down" style="font-weight: 500;font-size: 14px;">Order ID</td>
                                <td class="max-texts" style="font-weight: 500;font-size: 14px;">Date Invoiced</td>
                                <td class="hidden-xs-down" style="font-weight: 500;font-size: 14px;">Payment</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in backorders %}
                            <tr class="unread invoiceHistory" id="{{item.0}}" >
                                <td class="hidden-xs-down">{{item.0}}</td>
                                <td class="max-texts"><a class="invoiceDate" due="{{item.3}}"/>{{item.1}}</td>
                                {% if item.2 == "Not Sent" %}
                                <td class="hidden-xs-down"><span class="label label-primary m-r-10"><div class="invoicePaymentStatus">{{item.2}}</div></span></td>
                                {% elif item.2 == "Paid" %}
                                <td class="hidden-xs-down"><span class="label label-success m-r-10"><div class="invoicePaymentStatus">{{item.2}}</div></span></td>
                                {% endif %}
                            </tr>
                            {% endfor %}                         
                        </tbody>                        
                    </table>
                    <div id="modal_shipped" class="modal bs-example-modal-lg" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title">Last Invoiced</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                </div>
                                <div class="modal-body">
                                    <div class="row m-t-20" style="margin: 10px 20px 0px 20px; border-bottom: 1px solid #e9ecef;">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="control-label">Shipping Date</label>
                                                <input type="date" id="date_invoiceHistory" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-5"></div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="control-label">Order Number</label>
                                                <input type="text" id="orderId_invoiceHistory" class="form-control form-control-danger">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive m-t-20">
                                        <table id="tbl_invoiceHistory" class="table table-bordered table-striped myTable">
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Product Description</th>
                                                    <th>Cost($)</th>
                                                    <th>Ordered</th>
                                                    <th>BOrdered</th>
                                                    <th>Qty Shipped</th>
                                                </tr>
                                            </thead>
                                            <tfoot>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Product Description</th>
                                                    <th>Cost($)</th>
                                                    <th>Ordered</th>
                                                    <th>BOrdered</th>
                                                    <th>Qty Shipped</th>
                                                </tr>
                                            </tfoot>
                                            <tbody>
                                                
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="modal-footer" style="margin:10px;">
                                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                                        {% if request.session.userrole == "Supplier" %}
                                        <button type="button" id="btn_repeatLastInvoice" class="btn btn-primary waves-effect waves-light">Repeat & Create new Shipment</button>
                                        {% elif request.session.userrole == "Clinic User" or request.session.userrole == "Clinic Manager" %}
                                        <button type="button" id="btn_repeatHistoryOrder" class="btn btn-primary waves-effect waves-light">Repeat & Create new Order</button>
                                        {% endif %}
                                        <button type="button" id="btn_createInvoicePDF" class="btn btn-success waves-effect waves-light"><i class="far fa-file-pdf"></i>&nbsp;&nbsp;Invoice</button>
                                        <a href="" id="btn_download_packingslip" class="btn btn-info waves-effect waves-light" download><i class="ti-download"></i>&nbsp;&nbsp;Packing Slip</a>
                                    </div>
                                </div>
                            </div>
                           <div id="editor" style="display:none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="invoice-template" style="display:none;">
            <table id="invoice-company">
                <thead>
                    <tr>
                        <th>6570143 Canada Ltd. o/a 360EHS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            4164566030
                            <br>ahmed.chaudhry@360ehs.com
                            <br>GST Registration No.: 855494324RT0001
                            <br>PST Registration No.: 4978326
                            <br>Business Number 855494324
                        </td>
                    </tr>
                </tbody>
            </table>
            <table id="invoice-direction">
                <thead>
                    <tr>
                        <th>BILL TO</th>
                        <th>SHIP TO</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            CanAssess
                            <br>201-56 Aberfoyle Cres.
                            <br>Etobicoke, ON M8X 2W4
                        </td>
                        <td>
                            CanAssess
                            <br>CanAssess
                            <br>201-56 Aberfoyle Cres.
                            <br>Etobicoke, ON M8X 2W4
                        </td>
                    </tr>
                </tbody>
            </table>
            <table id="invoice-detail">
                <thead>
                    <tr>
                        <th>INVOICE #</th>
                        <th>DATE</th>
                        <th>DUE DATE</th>
                        <th>TERMS</th>
                        <th>P.O.NUMBER</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>5830</td>
                        <td>03-01-2020</td>
                        <td>02-02-2020</td>
                        <td>Net 30</td>
                        <td>3128</td>
                    </tr>
                </tbody>
            </table>
            <table id="invoice-template" width="100%">
                <thead>
                    <tr>
                        <th>CODE</th>
                        <th>DESCRIPTION</th>
                        <th>QTY</th>
                        <th>TAX</th>
                        <th>RATE</th>
                        <th>AMOUNT</th>
                    </tr>
                </thead>
                <tbody width="100%">
                    <tr>
                        <td>001-SC-103</td>
                        <td>Glove Exam Latex P/F N/S Promedix Medium Bx/100</td>
                        <td>10</td>
                        <td>H</td>
                        <td>9.99</td>
                        <td>99.90</td>
                    </tr>
                </tbody>
            </table>
            <table id="invoice-total">
                <tbody>
                    <tr>
                        <td>
                            SUBTOTAL
                            <br>GST @ 13%
                            <br>PST @ 0%
                        </td>
                        <td>
                            611.29
                            <br>79.49
                            <br>0.00
                        </td>
                    </tr>
                </tbody>
            </table>
            <table id="text-total-due">
                <tbody>
                    <tr>
                        <td>TOTAL</td>
                        <td>
                            CAD 690.76
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% block javascript %}
    <script type="text/javascript" src="{% static 'assets/node_modules/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/dropify/dist/js/dropify.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/bootstrap-switch/bootstrap-switch.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/switchery/dist/switchery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/select2/dist/js/select2.full.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/bootstrap-select/bootstrap-select.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/node_modules/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="https://rawgit.com/someatoms/jsPDF-AutoTable/master/dist/jspdf.plugin.autotable.js"></script>
    


    <script type="text/javascript">
        $(".bt-switch input[type='checkbox'], .bt-switch input[type='radio']").bootstrapSwitch();
        var paymentStatus = "";
        function initiateInvoiceHistory(elm){
            $("#btn_download_packingslip").css("display", "none");
            var id = $(elm).attr("id");
            var invoiceDate = $(elm).find('.invoiceDate').text();
            var invoiceDateDue = $(elm).find('.invoiceDate').attr("due");
            paymentStatus = $(elm).find('.invoicePaymentStatus').text();
            console.log(paymentStatus);

            $("#date_invoiceHistory").val(invoiceDate);
            $("#orderId_invoiceHistory").val(id);

            var formData = new FormData();
            formData.append("invoiceId", id);
            
            $.ajax({
                type: "POST",
                url: "/ajax/get/invoice_history/",
                data: formData,
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                processData: false,
                cache: false,
                contentType: false,
                success: function (data)
                {
                    if(data.result == "success"){
                        var tax_GST = 13; // 13%
                        var tax_PST = 0; // 0%
                        var subTotal = 0;

                        var rows = "";
                        var rows_invoice = "";
                        for(var i = 0; i < data.products.length; i ++){
                            rows += `<tr id="` + data.products[i][0] + `">
                                        <td>` + data.products[i][1] + `</td>
                                        <td>` + data.products[i][2] + `</td>
                                        <td>` + data.products[i][4] + `</td>
                                        <td class="qty_pre">` + data.products[i][6] + `</td>
                                        <td class="qty_back" value="` + data.products[i][10] + `">` + data.products[i][7] + `</td>
                                        <td class="touchspin-padding">
                                            <input id="tch3" type="number" value="` + data.products[i][8] + `" name="qty_ordered" data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline">
                                        </td>
                                    </tr>`

                            var amount = parseFloat(data.products[i][4]) * parseFloat(data.products[i][8]).toFixed(2);
                            subTotal += amount;

                            rows_invoice += `<tr>
                                                <td>` + data.products[i][1] + `</td>
                                                <td>` + data.products[i][2] + `</td>
                                                <td>` + data.products[i][8] + `</td>
                                                <td>H</td>
                                                <td>` + data.products[i][4] + `</td>
                                                <td>` + amount + `</td>
                                            </tr>`;
                        }


                        $("#tbl_invoiceHistory").find("tbody").html(rows);
                        $('#tbl_invoiceHistory').DataTable();
                        // $("input[name='qty_ordered']").TouchSpin();
                        
                        // Initiate Invoice Template
                        $("#invoice-template").find("tbody").html(rows_invoice);

                        rows_detail = `<tr>
                                            <td>` + id + `</td>
                                            <td>` + invoiceDate + `</td>
                                            <td>` + invoiceDateDue + `</td>
                                            <td>Net 30</td>
                                            <td>`+"{{request.session.orderid}}"+`</td>
                                        </tr>`;
                        $("#invoice-detail").find("tbody").html(rows_detail);

                        rows_subtotal = `<tr>
                                            <td>
                                                SUBTOTAL
                                                <br>GST @ ` + tax_GST + `%
                                                <br>PST @ ` + tax_PST + `%
                                            </td>
                                            <td>
                                                $ ` + parseFloat(subTotal).toFixed(2) + `
                                                <br>$ `+ parseFloat(subTotal * tax_GST / 100).toFixed(2) + `
                                                <br>$ `+ parseFloat(subTotal * tax_PST / 100).toFixed(2) + `
                                            </td>
                                        </tr>`;
                        $("#invoice-total").find("tbody").html(rows_subtotal);
                        
                        rows_total = `<tr>
                                        <td>TOTAL</td>
                                        <td>
                                            $ ` + parseFloat(subTotal + subTotal * tax_GST / 100 + subTotal * tax_PST / 100).toFixed(2) + ` CAD
                                        </td>
                                    </tr>`;
                        $("#text-total-due").find("tbody").html(rows_total);

                        console.log(data.packingslipURL);
                        if(data.packingslipURL != ""){
                            $("#btn_download_packingslip").css("display", "block");
                            $("#btn_download_packingslip").attr("href", "{{request.session.absoluteRoute}}"+data.packingslipURL);
                        }
                    }
                }
            });
        }

        $(document).ready(function() {
            
            var now = new Date();
            var day = ("0" + now.getDate()).slice(-2);
            var month = ("0" + (now.getMonth() + 1)).slice(-2);
            var today = now.getFullYear()+"-"+(month)+"-"+(day) ;

            $('#date_newInvoice').val(today);

            // $("input[name='qty_ordered']").TouchSpin({
            //     width: "100px",
            // });
            $('.myTable').DataTable();
            $('.dropify').dropify();

            $('#btn_addclinic').on('click', function(){
                var formData = new FormData();
                curURL = window.location.href;
                formData.append("curURL", curURL);

                $.ajax({
                    type: "POST",
                    url: "/ajax/accessAPI/",
                    data: formData,
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    processData: false,
                    cache: false,
                    contentType: false,
                    success: function (data)
                    {
                        var left = ($(window).width()/2)-(900/2),
                        top = ($(window).height()/2)-(600/2),
                        popup = window.open(data.result, "_self", "QBO Authentication", "width=800, height=500, top="+top+", left="+left);
                    }
                });
            });

            $('#btn_updateorder').on('click', function(){
                $.ajax({
                    type: "POST",
                    url: "/ajax/createPO/",
                    data: {},
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    processData: false,
                    cache: false,
                    contentType: false,
                    success: function (data)
                    {
                        console.log(data.result);
                        if(data.result == "success"){
                            Swal.fire({
                                icon: "success",
                                title: 'Success',
                                text: "This Order is successfully placed.",
                                type: 'success',
                                showCancelButton: false,
                                confirmButtonColor: '#00c292',
                                cancelButtonColor: '#e46a76',
                                confirmButtonText: 'Ok'
                            })
                            .then((result) => {
                                location.reload(true);
                            })
                        }else if(data.result == "error"){
                            Swal.fire({
                                icon: "error",
                                title: 'Error',
                                text: "You have to authenticate with QBO.",
                                type: 'error',
                                showCancelButton: false,
                                confirmButtonColor: '#00c292',
                                cancelButtonColor: '#e46a76',
                            })
                        }
                    }
                });
            });
            
            $("#tbl_invoiceList").delegate("tbody tr", "click", function(){
                initiateInvoiceHistory($(this));
                $('#modal_shipped').modal('show');
            });

            $("#btn_newship").on('click', function(){
                $.ajax({
                    type: "POST",
                    url: "/ajax/get/missed_orders/",
                    data: {},
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    processData: false,
                    cache: false,
                    contentType: false,
                    success: function (data)
                    {
                        if(data.result == "success"){
                            var rows = "";
                            for(var i = 0; i < data.products.length; i ++){
                                toInvoice = data.products[i][4] - data.products[i][6]
                                rows += `<tr id="` + data.products[i][0] + `">
                                            <td>` + data.products[i][1] + `</td>
                                            <td>` + data.products[i][2] + `</td>
                                            <td>` + data.products[i][3] + `</td>
                                            <td>` + data.products[i][4] + `</td>
                                            <td>` + data.products[i][6] + `</td>
                                            <td class="touchspin-padding">
                                                <input id="tch3" type="number" style="text-align:center;" value="` + toInvoice + `" name="qty_ordered" data-bts-button-down-class="btn btn-secondary btn-outline" data-bts-button-up-class="btn btn-secondary btn-outline">
                                            </td>
                                        </tr>`
                            }
                            $("#tbl_CreateInvoice").find("tbody").html(rows);
                            $('#tbl_CreateInvoice').DataTable();
                            // $("input[name='qty_ordered']").TouchSpin();
                        }
                    }
                });
            });
            
            $("#btn_repeatLastInvoice").on('click', function(){
                var formData = new FormData();
                shipid = $("#orderId_invoiceHistory").val();
                formData.append("userId", "{{request.session.userid}}");
                formData.append("invoiceId", shipid);

                var idArr = [];
                var qty_valid = "success";
                $("#tbl_invoiceHistory").find("tbody").find("tr").each(function(){
                    productId = $(this).attr("id");
                    qty = $(this).find("input").val();
                    qty_pre = $(this).find(".qty_pre").text();
                    qty_back = $(this).find(".qty_back").attr("value");

                    if(qty_pre - qty_back < qty){
                        qty_valid = "error";
                    }else if(qty > 0){
                        row = {'productId':productId, 'qty':qty};
                        idArr.push(row);
                    }
                });

                formData.append("products", JSON.stringify(idArr));

                if(shipid == ""){
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "Please enter the Order Id.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }else if(qty_valid == "error"){
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "Shipped QTY can't exceed the ordered count.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }else if (idArr.length > 0){
                    $.ajax({
                        type: "POST",
                        url: "/ajax/create/invoice/",
                        data: formData,
                        headers: { "X-CSRFToken": "{{ csrf_token }}" },
                        processData: false,
                        cache: false,
                        contentType: false,
                        success: function (data)
                        {
                            if(data.result=="success"){
                                Swal.fire({
                                    icon: "success",
                                    title: 'Success',
                                    text: "The Order is successfully placed.",
                                    type: 'success',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    location.reload(true);
                                })
                            }else if(data.result=="exist"){
                                Swal.fire({
                                    icon: "warning",
                                    title: 'Warning',
                                    text: "The Order ID already exists.",
                                    type: 'warning',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                })
                            }
                        }
                    });
                }else{
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "There are no orders to be invoiced.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }                
            });

            $("#btn_repeatLastOrder").on('click', function(){
                var formData = new FormData();

                var idArr = [];
                $("#tbl_orderedproducts").find("tbody").find("tr").each(function(){
                    productId = $(this).attr("id");
                    qty = $(this).find(".qty_ordered").text();

                    row = {'productId':productId, 'qty':qty};
                    idArr.push(row);
                });

                formData.append("idArr", JSON.stringify(idArr));

                if (idArr.length > 0){
                    $.ajax({
                        type: "POST",
                        url: "/ajax/repeat/history_order/",
                        data: formData,
                        headers: { "X-CSRFToken": "{{ csrf_token }}" },
                        processData: false,
                        cache: false,
                        contentType: false,
                        success: function (data)
                        {
                            if(data.result=="success"){
                                Swal.fire({
                                    icon: "success",
                                    title: 'Success',
                                    text: "The Order is successfully placed.",
                                    type: 'success',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    location.reload(true);
                                })
                            }else if(data.result=="exist"){
                                Swal.fire({
                                    icon: "warning",
                                    title: 'Warning',
                                    text: "The Order ID already exists.",
                                    type: 'warning',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                })
                            }
                        }
                    });
                }else{
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "There are no orders to be invoiced.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }                
            });

            $("#btn_repeatHistoryOrder").on('click', function(){
                var formData = new FormData();

                var idArr = [];
                $("#tbl_invoiceHistory").find("tbody").find("tr").each(function(){
                    productId = $(this).attr("id");
                    qty = $(this).find(".qty_pre").text();

                    row = {'productId':productId, 'qty':qty};
                    idArr.push(row);
                });

                formData.append("idArr", JSON.stringify(idArr));

                if (idArr.length > 0){
                    $.ajax({
                        type: "POST",
                        url: "/ajax/repeat/history_order/",
                        data: formData,
                        headers: { "X-CSRFToken": "{{ csrf_token }}" },
                        processData: false,
                        cache: false,
                        contentType: false,
                        success: function (data)
                        {
                            if(data.result=="success"){
                                Swal.fire({
                                    icon: "success",
                                    title: 'Success',
                                    text: "The Order is successfully placed.",
                                    type: 'success',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    location.reload(true);
                                })
                            }else if(data.result=="exist"){
                                Swal.fire({
                                    icon: "warning",
                                    title: 'Warning',
                                    text: "The Order ID already exists.",
                                    type: 'warning',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                })
                            }
                        }
                    });
                }else{
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "There are no orders to be invoiced.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }                
            });


            $("#btn_createinvoice").on('click', function(){
                var formData = new FormData();
                shipid = $("#tf_createshipid").val();
                formData.append("userId", "{{request.session.userid}}");
                formData.append("invoiceId", shipid);
                formData.append("byemail", $("#byemail").text());

                var idArr = [];
                $("#tbl_CreateInvoice").find("tbody").find("tr").each(function(){
                    productId = $(this).attr("id");
                    qty = $(this).find("input").val();

                    if(qty > 0){
                        row = {'productId':productId, 'qty':qty};
                        idArr.push(row);
                    }
                });

                formData.append("products", JSON.stringify(idArr));

                if(shipid == ""){
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "Please enter the Order Id.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }else if (idArr.length > 0){
                    $.ajax({
                        type: "POST",
                        url: "/ajax/create/invoice/",
                        data: formData,
                        headers: { "X-CSRFToken": "{{ csrf_token }}" },
                        processData: false,
                        cache: false,
                        contentType: false,
                        success: function (data)
                        {
                            if(data.result=="success"){
                                console.log("here");
                                Swal.fire({
                                    icon: "success",
                                    title: 'Success',
                                    text: "The New Shipment is successfully created.",
                                    type: 'success',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    location.reload(true);
                                })
                            }else if(data.result=="exist"){
                                Swal.fire({
                                    icon: "warning",
                                    title: 'Warning',
                                    text: "The Order ID already exists.",
                                    type: 'warning',
                                    showCancelButton: false,
                                    confirmButtonColor: '#00c292',
                                    confirmButtonText: 'OK'
                                })
                            }
                        }
                    });
                }else{
                    Swal.fire({
                        icon: "warning",
                        title: 'Warning',
                        text: "There are no orders to be invoiced.",
                        type: 'warning',
                        showCancelButton: false,
                        confirmButtonColor: '#00c292',
                        confirmButtonText: 'OK'
                    })
                }                
            });

            // Create New Invoice to QBO
            $("#btn_resend_order_emails").click(function(){
                $.ajax({
                    type: "POST",
                    url: "/ajax/create/invoice_to_QBO/",
                    data: {},
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    processData: false,
                    cache: false,
                    contentType: false,
                    success: function (data)
                    {
                        console.log(data.result);
                        if(data.result == "success"){
                            Swal.fire({
                                icon: "success",
                                title: 'Success',
                                text: "This Order is successfully placed.",
                                type: 'success',
                                showCancelButton: false,
                                confirmButtonColor: '#00c292',
                                cancelButtonColor: '#e46a76',
                                confirmButtonText: 'Ok'
                            })
                            .then((result) => {
                                // window.location.replace(curURL);
                            })
                        }else if(data.result == "error"){
                            Swal.fire({
                                icon: "error",
                                title: 'Error',
                                text: "You have to authenticate with QBO.",
                                type: 'error',
                                showCancelButton: false,
                                confirmButtonColor: '#00c292',
                                cancelButtonColor: '#e46a76',
                            })
                        }
                    }
                });
            });
        
            // Download Invoice PDF
            $('#btn_createInvoicePDF').click(function () {
                var doc = new jsPDF();
                doc.autoTable({ 
                    margin: { top: 30, left: 15, right: 15, bottom: 0 },
                    html: '#invoice-company',
                    startY: 10,
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    didParseCell: function (data) {
                        var rows = data.table.body;
                        if (data.row.index === rows.length - 1) {
                            data.cell.styles.fillColor = [255, 255, 255];
                        }
                    }
                });
                doc.setFontSize(20)
                doc.setTextColor(79, 144, 188)
                doc.text(
                    "INVOICE",
                    16, 50
                );

                doc.setFontSize(15)
                doc.setTextColor("black")
                doc.text(
                    paymentStatus,
                    16, 60
                );
                
                doc.setFontSize(12)
                doc.setTextColor("black")

                doc.autoTable({ 
                    margin: { top: 50, left: 15, right: 15, bottom: 0 },
                    html: '#invoice-direction',
                    startY: 65,
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    didParseCell: function (data) {
                        var rows = data.table.body;
                        if (data.row.index === rows.length - 1) {
                            data.cell.styles.fillColor = [255, 255, 255];
                        }
                    }
                });

                doc.setDrawColor(79, 144, 188);
                // doc.setLineDash([1, 1]);
                // doc.line(10, 95, 200, 95);

                doc.autoTable({ 
                    margin: { top: 30, left: 15, right: 15, bottom: 0 },
                    html: '#invoice-detail',
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    didParseCell: function (data) {
                        var rows = data.table.body;
                        if (data.row.index === rows.length - 1) {
                            data.cell.styles.fillColor = [255, 255, 255];
                        }
                    }
                });

                doc.autoTable({ 
                    margin: { top: 30, left: 7, right: 7, bottom: 0 },
                    html: '#invoice-template',
                    headStyles: {
                        fillColor: [220, 233, 241],
                        textColor: [79, 144, 188],
                        fontStyle: 'normal'
                    }
                });

                doc.autoTable({ 
                    margin: { top: 30, left: 18, right: 18, bottom: 0 },
                    html: '#invoice-total',
                    styles: {
                        halign: 'right',
                        fontSize: 12
                    },
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    didParseCell: function (data) {
                        var rows = data.table.body;
                        if (data.row.index === rows.length - 1) {
                            data.cell.styles.fillColor = [255, 255, 255];
                            data.cell.styles.textColor = [0, 0, 0];
                            data.cell.styles.lineHeight = 2;
                        }
                    }
                });

                doc.autoTable({ 
                    margin: { top: 10, left: 18, right: 18, bottom: 0 },
                    html: '#text-total-due',
                    
                    styles: {
                        fontStyle: 'bold',
                        halign: 'right',
                        fontSize: 15
                    },
                    
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                    },
                    didParseCell: function (data) {
                        var rows = data.table.body;
                        if (data.row.index === rows.length - 1) {
                            data.cell.styles.fillColor = [255, 255, 255];
                            data.cell.styles.textColor = [0, 0, 0];
                        }
                    }
                });

                doc.save('Invoice.pdf');
            });
            

        });

    </script>
{% endblock %}